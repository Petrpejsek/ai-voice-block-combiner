# AI Voice Block Combiner - Cursor Project Rules

## ğŸ¯ Projekt Overview
PokroÄilÃ¡ webovÃ¡ aplikace pro AI generovÃ¡nÃ­ hlasÅ¯, kombinovÃ¡nÃ­ audio a tvorbu videÃ­ s pouÅ¾itÃ­m ElevenLabs TTS, OpenAI API, MoviePy a FFmpeg.

## ğŸ—ï¸ Architektura
- **Backend:** Python Flask (port 50000)
- **Frontend:** React 18 + Tailwind CSS (port 4000)
- **APIs:** ElevenLabs TTS, OpenAI GPT-4o/DALL-E
- **Video/Audio:** MoviePy, FFmpeg, pydub

## ğŸ“ Struktura projektu
```
podcasts/
â”œâ”€â”€ backend/               # Python Flask server
â”‚   â”œâ”€â”€ app.py            # HlavnÃ­ Flask aplikace
â”‚   â”œâ”€â”€ gpt_utils.py      # OpenAI/DALL-E utilities
â”‚   â””â”€â”€ requirements.txt  # Python dependencies
â”œâ”€â”€ frontend/             # React aplikace
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.js       # HlavnÃ­ React komponenta
â”‚   â”‚   â””â”€â”€ components/  # ModulÃ¡rnÃ­ komponenty
â”‚   â””â”€â”€ package.json     # Node dependencies
â”œâ”€â”€ uploads/             # Input soubory
â”œâ”€â”€ output/              # VygenerovanÃ© soubory
â””â”€â”€ images/              # DALL-E generovanÃ© obrÃ¡zky
```

## ğŸ”§ Development Workflow

### Startup sekvence
```bash
# Terminal 1 - Backend
cd backend && python3 app.py  # Port 50000

# Terminal 2 - Frontend
cd frontend && PORT=4000 npm start  # Port 4000
```

### Environment setup
- VÅ¾dy pouÅ¾Ã­vej `.env` soubor v `backend/` pro API klÃ­Äe
- Nikdy necommituj API klÃ­Äe do gitu
- PouÅ¾Ã­vej `env_example.txt` jako template

## ğŸ’» Coding Standards

### Python Backend
```python
# âœ… SprÃ¡vnÃ© importy a error handling
try:
    from moviepy import ImageClip, VideoClip
    MOVIEPY_AVAILABLE = True
    print("âœ… MoviePy knihovny ÃºspÄ›Å¡nÄ› naÄteny")
except ImportError as e:
    print(f"âŒ Chyba pÅ™i importu MoviePy: {e}")
    MOVIEPY_AVAILABLE = False

# âœ… VÅ¾dy pouÅ¾ij secure_filename pro uploads
from werkzeug.utils import secure_filename
filename = secure_filename(file.filename)

# âœ… Timeout ochrana pro dlouhÃ© operace
@app.route('/api/process-video', methods=['POST'])
def process_video():
    try:
        # ProdlouÅ¾enÃ© timeout pro velkÃ© projekty
        result = subprocess.run(cmd, timeout=1800, capture_output=True)
    except subprocess.TimeoutExpired:
        return jsonify({"error": "ZpracovÃ¡nÃ­ trvalo pÅ™Ã­liÅ¡ dlouho"}), 408
```

### React Frontend
```jsx
// âœ… PouÅ¾Ã­vej funkÄnÃ­ komponenty s hooks
import React, { useState, useEffect } from 'react';

// âœ… Axios konfigurace s timeouty
const api = axios.create({
  baseURL: 'http://localhost:50000',
  timeout: 1800000, // 30 minut pro velkÃ© projekty
});

// âœ… Error boundary pro robustnÃ­ error handling
const [error, setError] = useState('');
const [isProcessing, setIsProcessing] = useState(false);

// âœ… ModulÃ¡rnÃ­ komponenty
import VideoProductionPipeline from './components/VideoProductionPipeline';
```

## ğŸ¤ ElevenLabs TTS Integration

### Voice Generation Best Practices
```python
# âœ… Batch zpracovÃ¡nÃ­ s retry mechanikou
def generate_voice_batch(voice_blocks, api_key):
    for voice_id, text in voice_blocks.items():
        try:
            response = requests.post(url, headers=headers, json=data, timeout=60)
            if response.status_code == 200:
                # Success handling
        except requests.exceptions.Timeout:
            # Retry logic
        except requests.exceptions.RequestException:
            # Error handling
```

### Voice Mapping
- PouÅ¾Ã­vej konzistentnÃ­ voice_id pro kaÅ¾dou postavu
- Tesla_01, Tesla_02 â†’ stejnÃ½ voice_id
- Socrates_01, Socrates_02 â†’ jinÃ½ voice_id
- Auto-sorting: Tesla_01 â†’ Socrates_01 â†’ Tesla_02...

## ğŸ¬ Video/Audio Processing

### MoviePy Operations
```python
# âœ… Ken Burns efekt s animacÃ­
def create_ken_burns_effect(image_path, duration, target_width, target_height):
    if not MOVIEPY_AVAILABLE:
        raise Exception("MoviePy nenÃ­ dostupnÃ©")
    
    clip = ImageClip(image_path, duration=duration)
    # Implementace zoom/pan efektÅ¯
    return clip.with_effects([zoom_effect, pan_effect])

# âœ… Memory management pro velkÃ© soubory
clip.close()  # VÅ¾dy uzavÅ™i clips po pouÅ¾itÃ­
```

### Audio Processing
```python
# âœ… pydub pro audio kombinovÃ¡nÃ­
from pydub import AudioSegment

def combine_audio_files(files, pause_ms=600):
    combined = AudioSegment.empty()
    for file in files:
        audio = AudioSegment.from_file(file)
        combined += audio + AudioSegment.silent(duration=pause_ms)
    return combined
```

## ğŸ›¡ï¸ Security & Error Handling

### API Key Management
```python
# âœ… Environment variables
import os
from dotenv import load_dotenv

load_dotenv()
api_key = os.getenv('ELEVENLABS_API_KEY')
if not api_key:
    raise ValueError("ElevenLabs API klÃ­Ä nenÃ­ nastaven")
```

### Robust Error Handling
```python
# âœ… Try-catch s specifickÃ½mi exceptions
try:
    result = process_video(file)
except subprocess.TimeoutExpired:
    return jsonify({"error": "Timeout - soubor je pÅ™Ã­liÅ¡ velkÃ½"}), 408
except FileNotFoundError:
    return jsonify({"error": "FFmpeg nenÃ­ nainstalovÃ¡n"}), 500
except Exception as e:
    logger.error(f"NeoÄekÃ¡vanÃ¡ chyba: {str(e)}")
    return jsonify({"error": "VnitÅ™nÃ­ chyba serveru"}), 500
```

## ğŸ“Š Performance Optimizations

### Memory Management
- PouÅ¾Ã­vej `clip.close()` po MoviePy operacÃ­ch
- Limituj max velikost uploadÅ¯ (100MB)
- Implementuj progress tracking pro dlouhÃ© operace

### Timeout Configurations
```javascript
// Frontend - prodlouÅ¾enÃ© timeouty
const api = axios.create({
  timeout: 1800000  // 30 minut pro velkÃ© projekty
});

// Backend - subprocess timeouts
subprocess.run(..., timeout=1800)  // 30 minut
```

## ğŸ§ª Testing Guidelines

### API Testing
```bash
# Health check
curl http://localhost:50000/api/health

# Voice generation test
curl -X POST http://localhost:50000/api/generate-voices \
  -H "Content-Type: application/json" \
  -d '{"voice_blocks": {...}, "api_key": "..."}'
```

### Development Testing
- VÅ¾dy testuj s malÃ½mi soubory first
- OvÄ›Å™ FFmpeg instalaci: `ffmpeg -version`
- Test ElevenLabs API connectivity pÅ™ed batch operacemi

## ğŸš« Common Pitfalls & Solutions

### Backend Issues
```python
# âŒ NekontrolovanÃ© memory usage
clip = VideoClip(...)  # Bez close()

# âœ… SprÃ¡vnÃ½ memory management
clip = VideoClip(...)
try:
    result = clip.process()
finally:
    clip.close()

# âŒ ChybÄ›jÃ­cÃ­ timeout
subprocess.run(cmd)  # MÅ¯Å¾e viset nekoneÄnÄ›

# âœ… S timeout ochranou
subprocess.run(cmd, timeout=1800)
```

### Frontend Issues
```jsx
// âŒ KrÃ¡tkÃ© timeouty pro velkÃ© soubory
axios.post(url, data, { timeout: 5000 })

// âœ… OdpovÃ­dajÃ­cÃ­ timeout pro operaci
axios.post(url, data, { timeout: 1800000 })

// âŒ ChybÄ›jÃ­cÃ­ progress indikÃ¡tor
const [isProcessing, setIsProcessing] = useState(false);

// âœ… S progress tracking
const [isProcessing, setIsProcessing] = useState(false);
const [progress, setProgress] = useState(0);
```

## ğŸ“ File Management

### Supported Formats
- **Audio:** MP3, WAV, M4A
- **Images:** PNG, JPG, JPEG (backgrounds)
- **Video:** MP4, MOV (video backgrounds)
- **Subtitles:** SRT

### File Organization
```
uploads/
â”œâ”€â”€ backgrounds/        # ObrÃ¡zky pozadÃ­
â”œâ”€â”€ video_backgrounds/ # Video pozadÃ­
â””â”€â”€ *.mp3             # Audio soubory

output/
â”œâ”€â”€ combined_*.mp3    # KombinovanÃ© audio
â”œâ”€â”€ final_*.mp4       # FinÃ¡lnÃ­ videa
â””â”€â”€ *.srt            # GenerovanÃ© titulky
```

## ğŸ”„ Development Commands

### Quick Start
```bash
# Restart celÃ© aplikace
./start.sh

# Backend only restart
cd backend && python3 app.py

# Frontend only restart
cd frontend && PORT=4000 npm start
```

### Debug Commands
```bash
# Backend logs
cd backend && FLASK_ENV=development python3 app.py

# Frontend s hot reload
cd frontend && npm start

# FFmpeg test
ffmpeg -version && echo "âœ… FFmpeg OK" || echo "âŒ FFmpeg Missing"
```

## ğŸ” Dependencies Monitoring

### Critical Dependencies
- **Python:** 3.8+ (backend compatibility)
- **Node.js:** 16+ (React 18 requirement)
- **FFmpeg:** 4.0+ (video/audio processing)
- **MoviePy:** Latest (video effects)
- **pydub:** Latest (audio processing)

### Regular Updates
```bash
# Backend dependencies update
cd backend && pip freeze > requirements.txt

# Frontend dependencies audit
cd frontend && npm audit && npm update
```

## ğŸ¯ Performance Targets

### Response Times
- **Small files (<10MB):** < 30 sekund
- **Medium files (10-50MB):** < 2 minuty
- **Large projects (120+ files):** < 20 minut

### Memory Usage
- **Minimum RAM:** 4GB
- **Recommended RAM:** 8GB+
- **Storage:** SSD doporuÄeno

## ğŸ”§ Integration Points

### ElevenLabs API
- Rate limiting: respektuj API limits
- Error codes: handle 429 (rate limit), 401 (auth), 500 (server)
- Retry strategy: exponential backoff

### OpenAI Integration
- Model: gpt-4o (default)
- Response format: JSON objects
- Temperature: 0.7 (balanced creativity)
- Max tokens: 4000

### FFmpeg Pipeline
- Input validation pÅ™ed zpracovÃ¡nÃ­m
- Progress callbacks pro UI feedback
- Error parsing z stderr output
- Cleanup temporary files

## ğŸ“š Documentation Requirements

### Code Comments
```python
def create_ken_burns_effect(image_path, duration, effect_type=0):
    """
    VytvoÅ™Ã­ Ken Burns efekt s animacÃ­
    
    Args:
        image_path (str): Cesta k obrÃ¡zku
        duration (float): DÃ©lka efektu v sekundÃ¡ch
        effect_type (int): 0=zoom_in, 1=zoom_out, 2=pan_left, 3=pan_right
    
    Returns:
        VideoClip: MoviePy clip s animacÃ­
    """
```

### Error Messages
- ÄŒeskÃ½ch error messages pro uÅ¾ivatele
- AnglickÃ© technickÃ© logy pro debugging
- Specific error codes pro API responses

## ğŸš€ Deployment Considerations

### Production Readiness
- Environment variables pro vÅ¡echny API klÃ­Äe
- CORS konfigurace pro production
- Nginx/Apache reverse proxy setup
- SSL certificates pro HTTPS
- Database backup strategy (pokud pouÅ¾ito)

### Monitoring
- API response times tracking
- Error rate monitoring
- Memory usage alerts
- Disk space monitoring (output folder)

---

**PoslednÃ­ aktualizace:** ÄŒervenec 2025
**Kompatibilita:** Python 3.8+, Node.js 16+, FFmpeg 4.0+
**Ports:** Frontend 4000, Backend 50000 